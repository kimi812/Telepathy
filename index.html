<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¿ƒé›»æ„Ÿæ‡‰âš¡ï¸</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #c0c4d1;
      margin: 0;
      padding: 0;
      color: #333;
    }
    header {
      background-color: #d1c0c4;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      margin: 0;
      font-size: 1.5em;
    }
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      padding: 10px;
    }
    .day {
      background-color: #f5f5f5;
      border: 1px solid #ccc;
      padding: 10px;
      min-height: 60px;
      position: relative;
      cursor: pointer;
    }
    .day.has-argue {
      border: 2px solid #d9534f;
    }
    .chat-container {
      display: none;
      position: fixed;
      bottom: 0;
      right: 0;
      width: 320px;
      max-height: 450px;
      background: #fff;
      border: 1px solid #ccc;
      display: flex;
      flex-direction: column;
      z-index: 999;
    }
    .chat-header {
      background-color: #d1c0c4;
      padding: 5px;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
    }
    .chat-messages {
      flex: 1;
      padding: 5px;
      overflow-y: auto;
      background: #eee;
    }
    .chat-input {
      display: flex;
    }
    .chat-input input {
      flex: 1;
      padding: 5px;
      border: 1px solid #ccc;
    }
    .chat-input button {
      padding: 5px 10px;
      background-color: #d1c0c4;
      border: none;
      cursor: pointer;
    }
    .settings {
      position: fixed;
      top: 50px;
      right: 10px;
      background: #fff;
      border: 1px solid #ccc;
      padding: 10px;
      display: none;
      flex-direction: column;
      z-index: 1000;
    }
    .settings button {
      margin-top: 5px;
      background-color: #d1c0c4;
      border: none;
      padding: 5px;
      cursor: pointer;
    }
    .stats {
      padding: 10px;
      background: #f0f0f0;
      margin-top: 10px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <header>
    <h1>å¿ƒé›»æ„Ÿæ‡‰âš¡ï¸</h1>
    <div>
      <button onclick="toggleSettings()">âš™ï¸è¨­å®š</button>
      <button onclick="toggleTheme()">ğŸŒ™æ—¥å¤œåˆ‡æ›</button>
    </div>
  </header>

  <div class="calendar-header" style="display:flex; justify-content:center; margin:10px 0;">
    <button onclick="prevMonth()">â†</button>
    <span id="currentMonthYear" style="margin:0 15px; font-weight:bold;"></span>
    <button onclick="nextMonth()">â†’</button>
  </div>

  <div class="calendar" id="calendar"></div>

  <!-- èŠå¤©å®¤ -->
  <div class="chat-container" id="chatContainer">
    <div class="chat-header">
      <span>èŠå¤© / åµæ¶åŸå› </span>
      <button onclick="closeChat()">âœ–</button>
    </div>
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input">
      <input type="text" id="chatInput" placeholder="è¼¸å…¥è¨Šæ¯">
      <button onclick="sendMessage()">é€å‡º</button>
    </div>
    <div style="padding:5px;">
      <input type="text" id="argueReason" placeholder="è¼¸å…¥åµæ¶åŸå› ">
      <button onclick="saveArgueReason()">å„²å­˜åŸå› </button>
    </div>
    <div class="stats" id="stats">
      <strong>çµ±è¨ˆ</strong><br>
      ç¸½åµæ¶æ¬¡æ•¸: <span id="totalArgues">0</span><br>
      æœ€å¸¸å‡ºç¾åŸå› : <span id="mostCommonReason">-</span>
    </div>
  </div>

  <!-- è¨­å®šé¢æ¿ -->
  <div class="settings" id="settingsPanel">
    <label>æš±ç¨±ï¼š
      <input type="text" id="nicknameInput">
      <button onclick="saveNickname()">å„²å­˜</button>
    </label>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    // Firebase è¨­å®š
    const firebaseConfig = {
      apiKey: "AIzaSyC0s0q3qmHlQ8n_PO0Uuz8QJY5lkNRKNYg",
      authDomain: "telepathy-bffe8.firebaseapp.com",
      databaseURL: "https://telepathy-bffe8-default-rtdb.firebaseio.com",
      projectId: "telepathy-bffe8",
      storageBucket: "telepathy-bffe8.firebasestorage.app",
      messagingSenderId: "102746710547",
      appId: "1:102746710547:web:7ce9a95ee58be10c5615e6",
      measurementId: "G-FEP4V5JRGY"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // å…¨åŸŸè®Šæ•¸
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let selectedDate = null;
    let nickname = localStorage.getItem('nickname') || 'åŒ¿å';

    document.getElementById('nicknameInput').value = nickname;

    function toggleSettings() {
      const panel = document.getElementById('settingsPanel');
      panel.style.display = panel.style.display === 'flex' ? 'none' : 'flex';
    }

    function toggleTheme() {
      if(document.body.style.backgroundColor === 'black'){
        document.body.style.backgroundColor = '#c0c4d1';
        document.body.style.color = '#333';
      } else {
        document.body.style.backgroundColor = 'black';
        document.body.style.color = 'white';
      }
    }

    function saveNickname() {
      nickname = document.getElementById('nicknameInput').value || 'åŒ¿å';
      localStorage.setItem('nickname', nickname);
      alert('æš±ç¨±å·²å„²å­˜: ' + nickname);
    }

    function renderCalendar(month = currentMonth, year = currentYear) {
      const calendar = document.getElementById('calendar');
      calendar.innerHTML = '';
      const monthYear = document.getElementById('currentMonthYear');
      monthYear.textContent = `${year} å¹´ ${month+1} æœˆ`;

      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month+1, 0).getDate();

      for(let i=0;i<firstDay;i++){
        const emptyCell = document.createElement('div');
        calendar.appendChild(emptyCell);
      }

      for(let day=1;day<=daysInMonth;day++){
        const dayDiv = document.createElement('div');
        dayDiv.className = 'day';
        dayDiv.innerHTML = `<span class="date-number">${day}</span>`;
        dayDiv.onclick = ()=>openChat(day, month, year);
        db.ref(`records/${year}-${month+1}-${day}/reason`).once('value', snapshot=>{
          if(snapshot.exists()){
            dayDiv.classList.add('has-argue');
          }
        });
        calendar.appendChild(dayDiv);
      }
    }

    function prevMonth() {
      currentMonth--;
      if(currentMonth<0){
        currentMonth=11;
        currentYear--;
      }
      renderCalendar(currentMonth, currentYear);
    }

    function nextMonth() {
      currentMonth++;
      if(currentMonth>11){
        currentMonth=0;
        currentYear++;
      }
      renderCalendar(currentMonth, currentYear);
    }

    function openChat(day, month, year){
      selectedDate = `${year}-${month+1}-${day}`;
      document.getElementById('chatContainer').style.display = 'flex';
      loadMessages(selectedDate);
      loadArgueReason(selectedDate);
    }

    function closeChat() {
      document.getElementById('chatContainer').style.display = 'none';
    }

    function loadMessages(date){
      const messagesDiv = document.getElementById('chatMessages');
      messagesDiv.innerHTML = '';
      db.ref(`records/${date}`).on('value', snapshot=>{
        messagesDiv.innerHTML = '';
        let totalArgues = 0;
        let reasonsArr = [];
        if(snapshot.exists()){
          snapshot.forEach(msgSnap=>{
            const data = msgSnap.val();
            if(data.message){
              const msgEl = document.createElement('div');
              msgEl.textContent = `${data.nickname}: ${data.message}`;
              messagesDiv.appendChild(msgEl);
            }
            if(data.reason){
              totalArgues++;
              reasonsArr.push(data.reason);
            }
          });
        }
        document.getElementById('totalArgues').textContent = totalArgues;
        document.getElementById('mostCommonReason').textContent = mostCommon(reasonsArr) || '-';
      });
    }

    function sendMessage(){
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      if(!message || !selectedDate) return;
      db.ref(`records/${selectedDate}`).push({
        nickname,
        message,
        timestamp: Date.now()
      });
      input.value = '';
    }

    function saveArgueReason(){
      const reasonInput = document.getElementById('argueReason');
      const reason = reasonInput.value.trim();
      if(!reason || !selectedDate) return;
      db.ref(`records/${selectedDate}`).push({
        nickname,
        reason,
        timestamp: Date.now()
      });
      reasonInput.value = '';
      renderCalendar(currentMonth, currentYear);
    }

    function loadArgueReason(date){
      const reasonInput = document.getElementById('argueReason');
      reasonInput.value = '';
    }

    function mostCommon(arr){
      if(arr.length===0) return '';
      const counts = {};
      arr.forEach(a=>{
        counts[a] = (counts[a]||0)+1;
      });
      let max=0;
      let most='';
      for(const key in counts){
        if(counts[key]>max){
          max = counts[key];
          most = key;
        }
      }
      return most;
    }

    renderCalendar();
  </script>
</body>
</html>
