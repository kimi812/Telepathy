<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¿ƒé›»æ„Ÿæ‡‰âš¡ï¸ v3.5</title>
  <style>
    body { font-family: 'Arial', sans-serif; background-color: #c0c4d1; color: #333; margin:0; transition: background-color 0.3s, color 0.3s; }
    header { background-color: #d1c0c4; padding:10px; display:flex; justify-content:space-between; flex-wrap:wrap; align-items:center; }
    header h1 { margin:0; font-size:1.5em; }
    button { cursor:pointer; transition:0.2s; }
    button:hover { opacity:0.8; }

    .calendar-header { text-align:center; margin:15px 0; }
    .calendar { display:grid; grid-template-columns:repeat(7,1fr); gap:5px; padding:10px; }
    .day { background-color:#f5f5f5; border:1px solid #ccc; padding:10px; height:70px; cursor:pointer; position:relative; text-align:center; transition:0.2s; }
    .day:hover { background-color:#e5e5e5; }
    .day.has-argue::after { content:"âœ–"; color:#e74c3c; font-weight:bold; position:absolute; right:5px; top:5px; }

    .chat-container { display:none; position:fixed; bottom:0; right:0; width:340px; max-height:500px; background:#fff; border:1px solid #ccc; flex-direction:column; z-index:999; box-shadow:0 0 10px rgba(0,0,0,0.3); }
    .chat-header { background-color:#d1c0c4; padding:5px; font-weight:bold; display:flex; justify-content:space-between; align-items:center; }
    .chat-header button { background:none; border:none; font-size:16px; cursor:pointer; }
    .chat-messages { flex:1; overflow-y:auto; background:#eee; padding:5px; }
    .chat-input { display:flex; padding:5px; background:#fafafa; }
    .chat-input input { flex:1; border:1px solid #ccc; padding:5px; }
    .chat-input button { background-color:#d1c0c4; border:none; padding:5px 10px; }

    .reason-section { background:#f4f4f4; padding:5px; border-top:1px solid #ccc; }

    .settings, .stats, .search, .export { position:fixed; top:60px; right:10px; background:#fff; border:1px solid #ccc; padding:10px; display:none; flex-direction:column; z-index:1000; width:300px; box-shadow:0 0 10px rgba(0,0,0,0.2); max-height:400px; overflow:auto; }
    .settings button, .stats button, .search button, .export button { margin-top:5px; background-color:#d1c0c4; border:none; padding:5px; cursor:pointer; }

    .night-mode { background-color:#222 !important; color:#fff !important; }
    .year-control { text-align:center; margin-bottom:5px; }

    table { width:100%; border-collapse: collapse; margin-top:5px; }
    th, td { border:1px solid #ccc; padding:5px; text-align:center; }
    th { background:#d1c0c4; }
    tr:hover { background:#f0f0f0; }
  </style>
</head>
<body>
  <header>
    <h1>å¿ƒé›»æ„Ÿæ‡‰âš¡ï¸ v3.5</h1>
    <div>
      <button onclick="toggleSearch()">ğŸ”æœå°‹</button>
      <button onclick="toggleStats()">ğŸ“Šçµ±è¨ˆ</button>
      <button onclick="toggleExport()">ğŸ“¦åŒ¯å‡º</button>
      <button onclick="toggleSettings()">âš™ï¸è¨­å®š</button>
      <button onclick="toggleTheme()">ğŸŒ™åˆ‡æ›</button>
    </div>
  </header>

  <div class="year-control">
    <button onclick="prevYear()">â†</button>
    <span id="currentYearLabel"></span>
    <button onclick="nextYear()">â†’</button>
  </div>

  <div class="calendar-header">
    <button onclick="prevMonth()">â†</button>
    <span id="currentMonthYear"></span>
    <button onclick="nextMonth()">â†’</button>
  </div>

  <div class="calendar" id="calendar"></div>

  <!-- èŠå¤©å®¤ -->
  <div class="chat-container" id="chatContainer">
    <div class="chat-header">
      <span id="chatDate"></span>
      <div>
        <button onclick="deleteRecord()" title="åˆªé™¤é€™å¤©ç´€éŒ„">ğŸ—‘ï¸</button>
        <button onclick="closeChat()">âœ–</button>
      </div>
    </div>
    <div class="reason-section">
      <input type="text" id="argueReason" placeholder="è¼¸å…¥åµæ¶åŸå› ">
      <button onclick="saveArgueReason()">ğŸ’¾ å„²å­˜</button>
    </div>
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input">
      <input type="text" id="chatInput" placeholder="è¼¸å…¥è¨Šæ¯">
      <button onclick="sendMessage()">é€å‡º</button>
    </div>
  </div>

  <!-- è¨­å®š -->
  <div class="settings" id="settingsPanel">
    <label>æš±ç¨±ï¼š
      <input type="text" id="nicknameInput">
      <button onclick="saveNickname()">å„²å­˜</button>
    </label>
    <button onclick="closeSettings()">é—œé–‰</button>
  </div>

  <!-- çµ±è¨ˆ -->
  <div class="stats" id="statsPanel">
    <h3>ğŸ“… å¹´åº¦çµ±è¨ˆ</h3>
    <div id="yearStats"></div>
    <button onclick="closeStats()">é—œé–‰</button>
  </div>

  <!-- æœå°‹ -->
  <div class="search" id="searchPanel">
    <h3>ğŸ” é—œéµå­—æœå°‹</h3>
    <input type="text" id="searchKeyword" placeholder="è¼¸å…¥é—œéµå­—">
    <button onclick="searchReasons()">æœå°‹</button>
    <div id="searchResults"></div>
    <button onclick="closeSearch()">é—œé–‰</button>
  </div>

  <!-- åŒ¯å‡ºè³‡æ–™ -->
  <div class="export" id="exportPanel">
    <h3>ğŸ“¦ åŒ¯å‡ºè³‡æ–™</h3>
    <label>é–‹å§‹æ—¥æœŸï¼š<input type="date" id="exportStart"></label>
    <label>çµæŸæ—¥æœŸï¼š<input type="date" id="exportEnd"></label>
    <button onclick="exportJSON()">åŒ¯å‡º JSON</button>
    <button onclick="exportCSV()">åŒ¯å‡º CSV</button>
    <button onclick="exportExcel()">åŒ¯å‡º Excel</button>
    <button onclick="exportPDF()">åŒ¯å‡º PDF</button>
    <button onclick="closeExport()">é—œé–‰</button>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <!-- ä¸‹è¼‰ CSV / Excel / PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC0s0q3qmHlQ8n_PO0Uuz8QJY5lkNRKNYg",
      authDomain: "telepathy-bffe8.firebaseapp.com",
      databaseURL: "https://telepathy-bffe8-default-rtdb.firebaseio.com",
      projectId: "telepathy-bffe8",
      storageBucket: "telepathy-bffe8.firebasestorage.app",
      messagingSenderId: "102746710547",
      appId: "1:102746710547:web:7ce9a95ee58be10c5615e6",
      measurementId: "G-FEP4V5JRGY"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let selectedDate = null;
    let nickname = localStorage.getItem('nickname') || 'åŒ¿å';
    document.getElementById('nicknameInput').value = nickname;

    // UI é–‹é—œ
    function toggleSettings() { togglePanel('settingsPanel'); }
    function toggleStats() { togglePanel('statsPanel'); if(document.getElementById('statsPanel').style.display==='flex') loadYearStats(); }
    function toggleSearch() { togglePanel('searchPanel'); }
    function toggleExport() { togglePanel('exportPanel'); }
    function togglePanel(id){ document.querySelectorAll('.settings, .stats, .search, .export').forEach(p=>p.style.display='none'); const panel=document.getElementById(id); panel.style.display=(panel.style.display==='flex')?'none':'flex'; }
    function closeStats(){ document.getElementById('statsPanel').style.display='none'; }
    function closeSearch(){ document.getElementById('searchPanel').style.display='none'; }
    function closeSettings(){ document.getElementById('settingsPanel').style.display='none'; }
    function closeExport(){ document.getElementById('exportPanel').style.display='none'; }
    function toggleTheme(){ document.body.classList.toggle('night-mode'); }

    // æš±ç¨±
    function saveNickname(){ nickname=document.getElementById('nicknameInput').value||'åŒ¿å'; localStorage.setItem('nickname',nickname); alert('æš±ç¨±å·²å„²å­˜: '+nickname); }

    // æ—¥æ›†
    function renderCalendar() {
      const cal=document.getElementById('calendar'); cal.innerHTML='';
      document.getElementById('currentMonthYear').textContent=`${currentYear} å¹´ ${currentMonth+1} æœˆ`;
      document.getElementById('currentYearLabel').textContent=`ğŸ“† ${currentYear}`;
      const firstDay=new Date(currentYear,currentMonth,1).getDay();
      const daysInMonth=new Date(currentYear,currentMonth+1,0).getDate();
      for(let i=0;i<firstDay;i++) cal.innerHTML+='<div></div>';
      for(let d=1;d<=daysInMonth;d++){
        const dateStr=`${currentYear}-${String(currentMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const div=document.createElement('div'); div.className='day'; div.textContent=d;
        db.ref('records/'+dateStr).get().then(snap=>{ if(snap.exists()){ div.classList.add('has-argue'); } });
        div.onclick=()=>openChat(dateStr); cal.appendChild(div);
      }
    }

    function prevMonth(){ currentMonth--; if(currentMonth<0){currentMonth=11; currentYear--; } renderCalendar(); }
    function nextMonth(){ currentMonth++; if(currentMonth>11){currentMonth=0; currentYear++; } renderCalendar(); }
    function prevYear(){ currentYear--; renderCalendar(); }
    function nextYear(){ currentYear++; renderCalendar(); }

    // èŠå¤©å®¤
    function openChat(date){ selectedDate=date; document.getElementById('chatDate').textContent=date; document.getElementById('chatContainer').style.display='flex'; loadChat(date); }
    function closeChat(){ document.getElementById('chatContainer').style.display='none'; }
    function loadChat(date){
      db.ref('records/'+date).get().then(snap=>{
        const data=snap.val()||{}; 
        document.getElementById('argueReason').value=data.reason||'';
        const chatDiv=document.getElementById('chatMessages'); chatDiv.innerHTML='';
        if(data.messages) Object.entries(data.messages).forEach(([k,v])=>{
          const p=document.createElement('div'); p.textContent=`[${v.user}] ${v.text}`; chatDiv.appendChild(p);
        });
      });
    }
    function saveArgueReason(){ if(!selectedDate) return; const reason=document.getElementById('argueReason').value; db.ref('records/'+selectedDate+'/reason').set(reason).then(()=>renderCalendar()); }
    function sendMessage(){
      if(!selectedDate) return; const input=document.getElementById('chatInput'); if(!input.value) return;
      const msg={user:nickname,text:input.value};
      db.ref('records/'+selectedDate+'/messages').push(msg).then(()=>{ input.value=''; loadChat(selectedDate); renderCalendar(); });
    }
    function deleteRecord(){ if(!selectedDate) return; if(confirm('ç¢ºå®šåˆªé™¤æ­¤æ—¥æœŸæ‰€æœ‰ç´€éŒ„ï¼Ÿ')) db.ref('records/'+selectedDate).remove().then(()=>{ closeChat(); renderCalendar(); }); }

    // çµ±è¨ˆè¡¨æ ¼
    async function loadYearStats(){
      const statsDiv=document.getElementById('yearStats'); statsDiv.innerHTML='è¼‰å…¥ä¸­...';
      const snapshot=await db.ref('records').once('value'); const records=snapshot.val()||{};
      let tableHTML=`<table><tr><th>æœˆä»½</th><th>åµæ¶æ¬¡æ•¸</th><th>è¨Šæ¯æ•¸é‡</th></tr>`;
      for(let m=0;m<12;m++){
        const monthRecords=Object.entries(records).filter(([date])=>{ const d=new Date(date); return d.getFullYear()===currentYear && d.getMonth()===m; });
        const argueCount=monthRecords.filter(([date,r])=>r.reason).length;
        let msgCount=0; monthRecords.forEach(([date,r])=>{ if(r.messages) msgCount+=Object.keys(r.messages).length; });
        tableHTML+=`<tr><td>${m+1} æœˆ</td><td>${argueCount}</td><td>${msgCount}</td></tr>`;
      }
      tableHTML+='</table>'; statsDiv.innerHTML=tableHTML;
    }

    // é—œéµå­—æœå°‹
    async function searchReasons(){
      const kw=document.getElementById('searchKeyword').value.trim(); if(!kw) return;
      const snapshot=await db.ref('records').once('value'); const records=snapshot.val()||{};
      let html=`<table><tr><th>æ—¥æœŸ</th><th>åŸå› </th></tr>`;
      Object.entries(records).forEach(([date,r])=>{ if(r.reason && r.reason.includes(kw)){ html+=`<tr><td>${date}</td><td>${r.reason}</td></tr>`; } });
      html+='</table>'; document.getElementById('searchResults').innerHTML=html;
    }

    // åŒ¯å‡º
    async function exportJSON(){
      const data=await db.ref('records').once('value'); download('records.json', JSON.stringify(data.val(), null,2)); }
    async function exportCSV(){
      const data=await db.ref('records').once('value'); const records=data.val()||{};
      let csv='æ—¥æœŸ,åŸå› ,è¨Šæ¯\n'; Object.entries(records).forEach(([date,r])=>{
        const msgs=r.messages?Object.values(r.messages).map(m=>m.text).join('|'):'';
        csv+=`"${date}","${r.reason||''}","${msgs}"\n`;
      }); download('records.csv', csv); }
    async function exportExcel(){
      const data=await db.ref('records').once('value'); const records=data.val()||{};
      const ws=XLSX.utils.json_to_sheet(Object.entries(records).map(([date,r])=>({æ—¥æœŸ:date,åŸå› :r.reason||'',è¨Šæ¯:r.messages?Object.values(r.messages).map(m=>m.text).join('|'):''})));
      const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Records'); XLSX.writeFile(wb, 'records.xlsx'); }
    async function exportPDF(){
      const data=await db.ref('records').once('value'); const records=data.val()||{};
      const { jsPDF } = window.jspdf; const doc=new jsPDF(); let y=10;
      Object.entries(records).forEach(([date,r])=>{
        const msgs=r.messages?Object.values(r.messages).map(m=>`[${m.user}] ${m.text}`).join(', '):'';
        doc.text(`${date} åŸå› :${r.reason||''} è¨Šæ¯:${msgs}`, 10, y); y+=10;
      }); doc.save('records.pdf'); }
    function download(filename, text){ const a=document.createElement('a'); a.href='data:text/plain;charset=utf-8,'+encodeURIComponent(text); a.download=filename; a.click(); }

    renderCalendar();
  </script>
</body>
</html>
